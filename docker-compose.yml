# =============================================================================
# Docker Compose - Legal Lease RAG Platform
# =============================================================================
# Orchestrates all services:
#   - backend:  FastAPI API server (Python)
#   - frontend: Next.js dashboard (Node.js)
#   - nginx:    Reverse proxy (routes traffic, SSL termination)
#
# Usage:
#   docker compose up -d --build    # Build and start all services
#   docker compose logs -f          # View all logs
#   docker compose down              # Stop all services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend: FastAPI + Gunicorn
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: platform-backend
    restart: unless-stopped

    env_file:
      - .env
    environment:
      - DOCKER_ENV=true
      # Network share is the input folder
      - WATCHDOG_INPUT_FOLDER=/data/98. Company Brain Trial
      - WATCHDOG_PROCESSED_FOLDER=/app/processed
    volumes:
      - ./data:/app/data
      - /data:/data:ro
      - ./processed:/app/processed
      - ./output:/app/output
      - flashrank_cache:/app/.flashrank_cache

    # Internal network - not exposed to host directly
    # Nginx will proxy to this service
    expose:
      - "8000"

    # Health check
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Dependency on other services (if any)
    networks:
      - app-network

  # ---------------------------------------------------------------------------
  # Frontend: Next.js
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: platform-frontend
    restart: unless-stopped

    environment:
      - NODE_ENV=production
      # Client-side API URL - empty for relative URLs via Nginx
      - NEXT_PUBLIC_API_URL=
      # Server-side API URL for Next.js API routes (proxy)
      - BACKEND_URL=http://backend:8000

    # Internal network only
    expose:
      - "3000"

    # Wait for backend to be healthy before starting
    depends_on:
      backend:
        condition: service_healthy

    networks:
      - app-network

  # ---------------------------------------------------------------------------
  # Nginx: Reverse Proxy
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: platform-nginx
    restart: unless-stopped

    # Expose to the outside world
    ports:
      - "80:80"
      # Uncomment for HTTPS (you'll need SSL certs):
      # - "443:443"

      # Mount nginx configuration
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Uncomment for SSL certificates:
      # - ./nginx/ssl:/etc/nginx/ssl:ro

    depends_on:
      - frontend
      - backend

    networks:
      - app-network

# =============================================================================
# Networks
# =============================================================================
networks:
  app-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # Named volume for FlashRank model cache
  flashrank_cache:
